#!/usr/bin/env node

const five = require('johnny-five');
const chipio = require('chip-io');
const WebSocket = require('ws');
const debug = require('debug')('pcw-io');

const WS_URL = process.env.PCW_WS_URL || 'ws://localhost:3000';
const PCW_DEBUG = process.env.PCW_DEBUG == 1;
const PCW_REPL = process.env.PCW_REPL == 1;

const BTN_PINS = ['XIO-P1','XIO-P3','XIO-P5'];
const BTN_PIN_PLAY_PAUSE = BTN_PINS[0];
const BTN_PIN_SKIP_LIKE = BTN_PINS[1];
const BTN_PIN_STATION = BTN_PINS[2];

var ws;
if(PCW_DEBUG === true) {
    ws = {
        send: function(message){ console.log('Sending: ' + message); }
    };
} else {
    ws = new WebSocket(WS_URL);

    ws.on('open', function open(){
        debug('WebSocket opened to ' + WS_URL);
    });

    ws.on('message', function(data, flags) {
        debug('Message received: ', data);
    });

    ws.on('close', function(){
        console.error('WebSocket closed!');
    });
}


var board = new five.Board({
    io: new chipio(),
    repl: PCW_REPL
});

board.on('ready', function() {
    debug('Board Ready');
    var btnPlayPause = makePlayPauseButton();
    var btnSkipLike = makeSkipLikeButton();
    var btnStation = makeStationButton();

    this.on('exit', function() {
        console.log('bye bye.');
    });
});

function makeButton(pin) {
    return new five.Button(pin);
}

function makePlayPauseButton() {
    let btn = makeButton(BTN_PIN_PLAY_PAUSE);

    btn.held = false;
    btn.on('down', function playPauseDown(){
        debug('Play/Pause down');
    });

    btn.on('hold', function playPauseHold(){
        if(!this.held) {
            this.held = true;
            debug('Play/Pause hold');
        }
    });

    btn.on('up', function playPauseUp(){
        if(this.held) {
            this.held = false;
            debug('Start/Stop Toggle...');
            ws.send(JSON.stringify({ event: 'start-stop' }));
        } else {
            debug('Pause Toggle...');
            ws.send(JSON.stringify({ event: 'pause-toggle', }));
        }
    });
}

function makeSkipLikeButton() {
    let btn = makeButton(BTN_PIN_SKIP_LIKE);

    btn.held = false;
    btn.on('down', function skipLikeDown(){
        debug('Skip/Like down');
    });

    btn.on('hold', function skipLikeHold(){
        if(!this.held) {
            this.held = true;
            debug('Skip/Like hold');
        }
    });

    btn.on('up', function skipLikeUp(){
        if(this.held) {
            this.held = false;
            debug('Liking...');
            ws.send(JSON.stringify({ event: 'like' }));
        } else {
            debug('Skipping...');
            ws.send(JSON.stringify({ event: 'skip', }));
        }
    });
}

function makeStationButton() {
    let btn = makeButton(BTN_PIN_STATION);

    btn.held = false;
    btn.on('down', function stationDown(){
        console.log('Station down');
    });

    btn.on('hold', function stationHold(){
        if(!this.held) {
            this.held = true;
            console.log('Station hold');
        }
    });

    btn.on('up', function stationUp(){
        if(this.held) {
            this.held = false;
            debug('Banning...');
            ws.send(JSON.stringify({ event: 'ban' }));
        } else {
            debug('Next Station...');
            ws.send(JSON.stringify({ event: 'station-next' }));
        }
    });
}